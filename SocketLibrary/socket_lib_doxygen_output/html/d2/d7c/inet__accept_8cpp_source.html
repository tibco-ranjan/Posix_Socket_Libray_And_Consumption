<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>socketLibrary: tcpSocket/source/inet_accept.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">socketLibrary
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d2/d7c/inet__accept_8cpp_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">inet_accept.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d2/d7c/inet__accept_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../da/df9/tcp__common_8h.html">tcp_common.h</a>&quot;</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d9/dc9/inet__socket_8h.html">inet_socket.h</a>&quot;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../da/d4e/inet__accept_8h.html">inet_accept.h</a>&quot;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">using namespace </span>std;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../da/d4e/inet__accept_8h.html#ad7ca1270d91921eb3b2502d3bc6fec19">non_blocking_accept</a></div>
<div class="line"><a name="l00022"></a><span class="lineno"><a class="line" href="../../d2/d7c/inet__accept_8cpp.html#ad7ca1270d91921eb3b2502d3bc6fec19">   22</a></span>&#160;(</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> listen_sd</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;)</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;{</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;   fd_set master_set, working_set;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;   <span class="keyword">struct </span>timeval      timeout;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;     <span class="keywordtype">int</span>     max_sd, new_sd, i, rc, len, status = 0;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;   <span class="keywordtype">char</span>   buffer[80];</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;   <span class="keywordtype">int</span>    desc_ready, end_server = <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;   <span class="keywordtype">int</span>    close_conn;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;     <span class="keywordtype">char</span> peerAddr[INET6_ADDRSTRLEN];</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port = 0;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;   <span class="comment">/* Initialize the master fd_set                              */</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;   FD_ZERO(&amp;master_set);</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;   max_sd = listen_sd;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;   FD_SET(listen_sd, &amp;master_set);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;   <span class="comment">/* Initialize the timeval struct to 3 minutes.  If no        */</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;   <span class="comment">/* activity after 3 minutes this program will end.           */</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;   timeout.tv_sec  = 3 * 60;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;   timeout.tv_usec = 0;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;   <span class="comment">/* Loop waiting for incoming connects or for incoming data   */</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;   <span class="comment">/* on any of the connected sockets.                          */</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;   <span class="keywordflow">do</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;   {</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;      <span class="comment">/* Copy the master fd_set over to the working fd_set.     */</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;      memcpy(&amp;working_set, &amp;master_set, <span class="keyword">sizeof</span>(master_set));</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;      <span class="comment">/* Call select() and wait 3 minutes for it to complete.   */</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;      <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;Waiting on select()...\n&quot;</span>);</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;      rc = select(max_sd + 1, &amp;working_set, NULL, NULL, &amp;timeout);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;      <span class="comment">/* Check to see if the select call failed.                */</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;      <span class="keywordflow">if</span> (rc &lt; 0)</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;      {</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;         perror(<span class="stringliteral">&quot;  select() failed&quot;</span>);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;         <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;      }</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;      <span class="comment">/* Check to see if the 3 minute time out expired.         */</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;      <span class="keywordflow">if</span> (rc == 0)</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;      {</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;         <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;  select() timed out.  End program.\n&quot;</span>);</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;         <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;      }</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;      <span class="comment">/* One or more descriptors are readable.  Need to         */</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;      <span class="comment">/* determine which ones they are.                         */</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;      <span class="comment">/**********************************************************/</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;      desc_ready = rc;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;      <span class="keywordflow">for</span> (i=0; i &lt;= max_sd  &amp;&amp;  desc_ready &gt; 0; ++i)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;      {</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;         <span class="comment">/*******************************************************/</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;         <span class="comment">/* Check to see if this descriptor is ready            */</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;         <span class="comment">/*******************************************************/</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;         <span class="keywordflow">if</span> (FD_ISSET(i, &amp;working_set))</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;         {</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            <span class="comment">/****************************************************/</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            <span class="comment">/* A descriptor was found that was readable - one   */</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            <span class="comment">/* less has to be looked for.  This is being done   */</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            <span class="comment">/* so that we can stop looking at the working set   */</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            <span class="comment">/* once we have found all of the descriptors that   */</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="comment">/* were ready.                                      */</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            <span class="comment">/****************************************************/</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            desc_ready -= 1;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <span class="comment">/****************************************************/</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            <span class="comment">/* Check to see if this is the listening socket     */</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            <span class="comment">/****************************************************/</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            <span class="keywordflow">if</span> (i == listen_sd)</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            {</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;               <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;  Listening socket is readable\n&quot;</span>);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;               <span class="comment">/*************************************************/</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;               <span class="comment">/* Accept all incoming connections that are      */</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;               <span class="comment">/* queued up on the listening socket before we   */</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;               <span class="comment">/* loop back and call select again.              */</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;               <span class="comment">/*************************************************/</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;               <span class="keywordflow">do</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;               {</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                  <span class="comment">/* Accept each incoming connection.  If       */</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                  <span class="comment">/* accept fails with EWOULDBLOCK, then we     */</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                  <span class="comment">/* have accepted all of them.  Any other      */</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                  <span class="comment">/* failure on accept will cause us to end the */</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                  <span class="comment">/* server.                                    */</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                  new_sd = accept(listen_sd, NULL, NULL);</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                  <span class="keywordflow">if</span> (new_sd &lt; 0)</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                  {</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3d/common_2README.html#afe75ee0c7e5a90ba6bb38426ea69b996">errno</a> != EWOULDBLOCK)</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                     {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                        perror(<span class="stringliteral">&quot;  accept() failed&quot;</span>);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                        end_server = <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                     }</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                     <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                  }</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                  <span class="comment">/* Add the new incoming connection to the     */</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                  <span class="comment">/* master read set                            */</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                  <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;  New incoming connection - %d, sending the welcome message\n&quot;</span>, new_sd);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                                    </div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                                    <span class="comment">//Log the client details from where the connection is requested.</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                                    <span class="keywordflow">if</span>((status = <a class="code" href="../../d9/dc9/inet__socket_8h.html#a0d17436cdcdef6e93730b193008e9de8">get_peer_addr_with_peer_conn_fd</a>(new_sd, peerAddr, &amp;port)) == -1) {</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                                  cout&lt;&lt;<span class="stringliteral">&quot;get_peer_name_by_cfd failed, error=&quot;</span>&lt;&lt;gai_strerror(new_sd)&lt;&lt;<span class="stringliteral">&quot; errno=&quot;</span> &lt;&lt;<a class="code" href="../../d2/d3d/common_2README.html#afe75ee0c7e5a90ba6bb38426ea69b996">errno</a>&lt;&lt; endl;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                                <a class="code" href="../../d2/d3d/common_2README.html#a85c39bfe84eed5e1d7dae87fb0018669">exit</a>(1);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                                }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                                    <span class="comment">//send new connection greeting message  </span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                                    <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keyword">const</span> message = <span class="stringliteral">&quot;Welcome New Client&quot;</span>;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                                    <span class="keywordflow">if</span>( send(new_sd, message, strlen(message), 0) != strlen(message) )   </div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                        {   </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                            perror(<span class="stringliteral">&quot;send&quot;</span>);   </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                        }  </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                                    <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;Welcome message send successfully\n&quot;</span>);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                                    </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                  FD_SET(new_sd, &amp;master_set);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                  <span class="keywordflow">if</span> (new_sd &gt; max_sd)</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                     max_sd = new_sd;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                  <span class="comment">/* Loop back up and accept another incoming   */</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                  <span class="comment">/* connection                                 */</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;               } <span class="keywordflow">while</span> (new_sd != -1);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            }</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            <span class="comment">/****************************************************/</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            <span class="comment">/* This is not the listening socket, therefore an   */</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            <span class="comment">/* existing connection must be readable             */</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            <span class="comment">/****************************************************/</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;               <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;  Descriptor %d is readable\n&quot;</span>, i);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;               close_conn = <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;               <span class="comment">/*************************************************/</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;               <span class="comment">/* Receive all incoming data on this socket      */</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;               <span class="comment">/* before we loop back and call select again.    */</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;               <span class="comment">/*************************************************/</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;               <span class="keywordflow">do</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;               {</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                  <span class="comment">/* Receive data on this connection until the  */</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                  <span class="comment">/* recv fails with EWOULDBLOCK.  If any other */</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                  <span class="comment">/* failure occurs, we will close the          */</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                  <span class="comment">/* connection.                                */</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                  rc = recv(i, buffer, <span class="keyword">sizeof</span>(buffer), 0);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                  <span class="keywordflow">if</span> (rc &lt; 0)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                  {</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3d/common_2README.html#afe75ee0c7e5a90ba6bb38426ea69b996">errno</a> != EWOULDBLOCK)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                     {</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                        perror(<span class="stringliteral">&quot;  recv() failed&quot;</span>);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                        close_conn = <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                     }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                     <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                  }</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                  <span class="comment">/* Check to see if the connection has been    */</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                  <span class="comment">/* closed by the client                       */</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                  <span class="keywordflow">if</span> (rc == 0)</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                  {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                     <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;  Connection closed\n&quot;</span>);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                     close_conn = <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                     <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                  }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                  <span class="comment">/* Data was received                          */</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                  len = rc;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                  <a class="code" href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a>(<span class="stringliteral">&quot;  %d bytes received\n&quot;</span>, len);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                  <span class="comment">/* Echo the data back to the client           */</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                  <span class="comment">/**********************************************/</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                  rc = send(i, buffer, len, 0);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                  <span class="keywordflow">if</span> (rc &lt; 0)</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                  {</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                     perror(<span class="stringliteral">&quot;  send() failed&quot;</span>);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                     close_conn = <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                     <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                  }</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;               } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa82764c3079aea4e60c80e45befbb839">TRUE</a>);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;               <span class="comment">/*************************************************/</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;               <span class="comment">/* If the close_conn flag was turned on, we need */</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;               <span class="comment">/* to clean up this active connection.  This     */</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;               <span class="comment">/* clean up process includes removing the        */</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;               <span class="comment">/* descriptor from the master set and            */</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;               <span class="comment">/* determining the new maximum descriptor value  */</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;               <span class="comment">/* based on the bits that are still turned on in */</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;               <span class="comment">/* the master set.                               */</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;               <span class="comment">/*************************************************/</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;               <span class="keywordflow">if</span> (close_conn)</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;               {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                  close(i);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                  FD_CLR(i, &amp;master_set);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                  <span class="keywordflow">if</span> (i == max_sd)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                  {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                     <span class="keywordflow">while</span> (FD_ISSET(max_sd, &amp;master_set) == <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>)</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                        max_sd -= 1;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                  }</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;               }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            } <span class="comment">/* End of existing connection is readable */</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;         } <span class="comment">/* End of if (FD_ISSET(i, &amp;working_set)) */</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;      } <span class="comment">/* End of loop through selectable descriptors */</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;   } <span class="keywordflow">while</span> (end_server == <a class="code" href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;   <span class="comment">/* Clean up all of the sockets that are open                 */</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;   <span class="comment">/*************************************************************/</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;   <span class="keywordflow">for</span> (i=0; i &lt;= max_sd; ++i)</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;   {</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;      <span class="keywordflow">if</span> (FD_ISSET(i, &amp;master_set))</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;         close(i);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;   }</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;     <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;}</div>
<div class="ttc" id="common_2README_html_ae46f6c5c5729768631dc5ff84e16d52b"><div class="ttname"><a href="../../d2/d3d/common_2README.html#ae46f6c5c5729768631dc5ff84e16d52b">printf</a></div><div class="ttdeci">including errors from library functions that don’t set errno Its argument list is the same as for printf()</div></div>
<div class="ttc" id="tlpi__hdr_8h_html_aec7e62084419d7857ae740a4c68241cfaa82764c3079aea4e60c80e45befbb839"><div class="ttname"><a href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa82764c3079aea4e60c80e45befbb839">TRUE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d75/tlpi__hdr_8h_source.html#l00014">tlpi_hdr.h:14</a></div></div>
<div class="ttc" id="inet__accept_8h_html_ad7ca1270d91921eb3b2502d3bc6fec19"><div class="ttname"><a href="../../da/d4e/inet__accept_8h.html#ad7ca1270d91921eb3b2502d3bc6fec19">non_blocking_accept</a></div><div class="ttdeci">int non_blocking_accept(const int listen_sd)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d7c/inet__accept_8cpp_source.html#l00022">inet_accept.cpp:22</a></div></div>
<div class="ttc" id="tlpi__hdr_8h_html_aec7e62084419d7857ae740a4c68241cfaa1e095cc966dbecf6a0d8aad75348d1a"><div class="ttname"><a href="../../d4/d75/tlpi__hdr_8h.html#aec7e62084419d7857ae740a4c68241cfaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d75/tlpi__hdr_8h_source.html#l00014">tlpi_hdr.h:14</a></div></div>
<div class="ttc" id="common_2README_html_afe75ee0c7e5a90ba6bb38426ea69b996"><div class="ttname"><a href="../../d2/d3d/common_2README.html#afe75ee0c7e5a90ba6bb38426ea69b996">errno</a></div><div class="ttdeci">except that a terminating newline character is automatically appended to the output string The such as plus the error description as returned by but also terminates the by calling but differs in two except that instead of printing the error text corresponding to the current value of errno</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d3d/common_2README_source.html#l00028">README:28</a></div></div>
<div class="ttc" id="inet__socket_8h_html_a0d17436cdcdef6e93730b193008e9de8"><div class="ttname"><a href="../../d9/dc9/inet__socket_8h.html#a0d17436cdcdef6e93730b193008e9de8">get_peer_addr_with_peer_conn_fd</a></div><div class="ttdeci">int get_peer_addr_with_peer_conn_fd(const int fd, char *peer_name, unsigned short *port)</div><div class="ttdoc">: get sockaddr, IPv4 or IPv6 IP address and port number Note: Used to get the connecting client IP ad...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/dd1/inet__socket_8cpp_source.html#l00104">inet_socket.cpp:104</a></div></div>
<div class="ttc" id="tcp__common_8h_html"><div class="ttname"><a href="../../da/df9/tcp__common_8h.html">tcp_common.h</a></div></div>
<div class="ttc" id="inet__accept_8h_html"><div class="ttname"><a href="../../da/d4e/inet__accept_8h.html">inet_accept.h</a></div></div>
<div class="ttc" id="inet__socket_8h_html"><div class="ttname"><a href="../../d9/dc9/inet__socket_8h.html">inet_socket.h</a></div></div>
<div class="ttc" id="common_2README_html_a85c39bfe84eed5e1d7dae87fb0018669"><div class="ttname"><a href="../../d2/d3d/common_2README.html#a85c39bfe84eed5e1d7dae87fb0018669">exit</a></div><div class="ttdeci">except that a terminating newline character is automatically appended to the output string The such as plus the error description as returned by but also terminates the by calling exit().The err_exit() function is similar to errExit()</div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_d61e5ac0c0dd8a2f58b850debc7bb838.html">tcpSocket</a></li><li class="navelem"><a class="el" href="../../dir_c5f260f06f8ea0c7169cb637da2cda86.html">source</a></li><li class="navelem"><a class="el" href="../../d2/d7c/inet__accept_8cpp.html">inet_accept.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
